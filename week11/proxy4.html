<html>
  <body>
    <script lang="javascript">
      let callbacks = new Map();
      let usedReactives = [];
      let obj = {
          a: 1,
          b: 2,
      };
      let po = new reactive(obj);

      effect(() => {
        console.log(po.a);
      });

      function effect(callback) {
        // callbacks.push(callback);
        usedReactives = [];
        callback();
        console.log(usedReactives);
        for (let ur of usedReactives) {
            if (!callbacks.has(ur[0])) {
                callbacks.set(ur[0], new Map());
            }
            if (!callbacks.get(ur[0]).has(ur[1])) {
                callbacks.get(ur[0]).set(ur[1], []);
            }
            callbacks.get(ur[0]).get(ur[1]).push(callback);
        }
        
      }

      function reactive(obj) {
        return new Proxy(obj, {
            set: (obj, prop, val) => {
                obj[prop] = val;

                if (callbacks.get(obj))
                    if (callbacks.get(obj).get(prop))
                        for (let callback of callbacks.get(obj).get(prop)) callback();

                for (let callback of callbacks) {
                  callback();
                }
                return obj[prop];
            },
            get: (obj, prop) => {
                // console.log(obj, prop);
                usedReactives.push([obj, prop])
                return obj[prop];
            }
        })
      }
      // console测试：po.a = 1
    </script>
  </body>
</html>
